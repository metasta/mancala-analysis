<!DOCTYPE html>
<meta name="viewport" content="initial-scale=1.0">
<meta name="robots" content="noindex">
<title>「マンカラ」の完全解析</title>
<link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
<style>
body {
 margin: 0;
 padding: 0;
 font-family: sans-serif;
}
u {
 text-decoration: inherit;
 display: inline-block;
 white-space: nowrap;
}
a[href] {
 color: inherit;
}
#game {
 max-width: 960px;
 text-align: center;
 margin: 0 auto;
}
.msg {
 display: flex;
 flex-flow: row wrap;
 justify-content: space-between;
 margin: 0 auto;
 padding: 0;
 width: 312px;
 height: 40px;
 font-family: "Verdana";
}
.msg li {
 list-style: none;
 margin: 0;
 padding: 0;
 width: 54px;
 text-align: center;
 font-size: 16px;
}
#fields {
 display: flex;
 flex-flow: row wrap;
 justify-content: space-between;
 align-items: center;
 margin: 0 auto;
 padding: 0;
 width: 312px;
 height: 192px;
}
#fields li {
 list-style: none;
 margin: 0;
 padding: 0;
 width: 54px;
 height: 54px;
 font-size: 40px;
 line-height: 54px;
 text-align: center;
 font-family: 'Roboto Mono',monospace;
}
#fields li.first,
#fields li.second,
#fields li.store {
 border: 3px solid #333;
}
#fields li.first,
#fields li.second {
 cursor: pointer;
}
#fields li.disabled,
#fields li.store {
 opacity: .3;
 cursor: inherit;
}
#buttons {
 display: flex;
 flex-flow: row nowrap;
 justify-content: center;
 margin: 0; padding: 0;
}
#buttons li {
 list-style: none;
 margin: 20px 10px;
 padding: 10px;
 width: 40px;
 height: 40px;
 cursor: pointer;
}
#buttons path {
 fill: #333;
}
#back.disabled,
#reset.disabled {
 opacity: .4;
 cursor: inherit;
}
#instruction {
 margin: 0 auto;
 padding: 0 10px;
 max-width: 960px;
}

@media(prefers-color-scheme: dark){
 body {
  background: #222;
  color: #fff;
 }
 #fields li.first,
 #fields li.second,
 #fields li.store {
  border: 3px solid #ccc;
 }
 #buttons path {
  fill: #ccc;
 }
}
</style>
<div id="game">
 <h1><u>「マンカラ」の</u><u>完全解析</u></h1>
 <ul id="second" class="msg">
  <li style="order:3">
  <li style="order:2">
  <li style="order:1">
  <li style="order:0; visibility: hidden">
  <li style="order:4; visibility: hidden">
 </ul>
 <ul id="fields">
  <li style="order:12" class="first disabled" onclick="sow(0,0)">3
  <li style="order:13" class="first disabled" onclick="sow(0,1)">3
  <li style="order:14" class="first disabled" onclick="sow(0,2)">3
  <li style="order:10" class="store disabled">
  <li style="order:4" class="second disabled" onclick="sow(1,0)">3
  <li style="order:3" class="second disabled" onclick="sow(1,1)">3
  <li style="order:2" class="second disabled" onclick="sow(1,2)">3
  <li style="order:6" class="store">
  <li style="order:1">
  <li style="order:5">
  <li style="order:7">
  <li style="order:8">
  <li style="order:9">
  <li style="order:11">
  <li style="order:15">
 </ul>
 <ul id="first" class="msg">
  <li style="order:1">
  <li style="order:2">
  <li style="order:3">
  <li style="order:0; visibility: hidden">
  <li style="order:4; visibility: hidden">
 </ul>
</div>
<div id="console">
 <ul id="buttons">
  <li id="back" title="back" onclick="wayback()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448 241c-39-39-94-64-154-64h-51V86a22 22 0 00-34-17L9 212a22 22 0 000 35l200 143a22 22 0 0034-18v-91h51a113 113 0 01114 114 52 52 0 00104 0c0-60-24-115-64-154z"/></svg>
  <li id="reset" title="reset" onclick="reset()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M390 88l-55 78a138 138 0 11-116-20v41l93-93-93-94v49a233 233 0 10171 39z"/></svg>
 </ul>
</div>
<div id="instruction">
<p>「マンカラ」は2人で遊ぶボードゲームです。交互に駒を進め、先に自分の陣地を空にしたプレイヤーが勝者となります。<a href="https://www.youtube.com/watch?v=OL3m2ZbKb1o">QuizKnockのプレイ動画</a>にわかりやすいルール説明があります。</p>
<p><a href="https://www.youtube.com/watch?v=QYlCPntI8Bw">サブチャンネル動画</a>でも言及がある通り、「マンカラ」は二人零和有限確定完全情報ゲームであり、理論上は完全な先読みが可能です。今回、後退解析 (retrograde analysis) により初期局面から到達可能なすべての局面を解析した結果、初期局面は24手の先手必勝形であることがわかりました。また先手が勝つためには「左→中央」と2連続で動かす手順（前掲のプレイ動画内で「QuizKnockの定石」と呼ばれた手順）が必須であることもわかりました。</p>
<p>前掲の盤面はこの解析結果を実際のゲームの形で表現したものです。各着手に表示される「<span style="font-family: Verdana">WIN/LOSE</span>」がその手を選んだ際の試合結果、括弧内の数字が決着までに要する残り手数を表します。</p><br />
<h2>発展課題</h2>
<p>「マンカラ」には多くのローカルルールがあり、今回の解析結果は「陣地は3つ、各陣地内の初期駒数は3個」のQuizKnockルールにのみ有効です。陣地や駒の個数が異なる場合は別の解析を必要とします。</p>
<h2>技術情報</h2>
<ul>
<li>各局面を7つの数字の組で表現した。1-6番目の数字は各陣地内の駒数（先手左端から反時計回り）、7番目の数字は手番（先手 <code>0</code> 後手 <code>1</code>）を表す。初期局面は <code>[3,3,3,3,3,3,0]</code>、先手が初手で中央を選んだ後の局面は <code>[3,0,4,4,3,3,1]</code> と表される。
<li>初期局面から勝敗が決するまでの間に到達しうる全局面を列挙する処理をPythonで記述した。処理時間は Dual-Core Intel Core i5 1.6GHz, Python3.7.6で約75秒。全12,075個の局面が得られた。
<li>全局面について理論値（先手勝ち or 後手勝ち）と残り手数を求める処理をPythonで記述した。処理時間は上記と同一環境で約2秒。
<li>7つの数字の組を7文字の文字列に置換することで全解析結果のデータは約 150KB に収まった。本ページはこのデータをjavascriptで読み込み動作する。
</ul>
<h2>参考文献</h2>
<ul>
<li><a href="https://www.tanaka.ecc.u-tokyo.ac.jp/ktanaka/dobutsushogi/animal-private.pdf">「どうぶつしょうぎ」の完全解析</a>, 田中 哲朗, 情報処理学会研究報告. GI, [ゲーム情報学] 22, C1-C8, 2009-06-26
</ul>
</div>
<script src="db.js"></script>
<script src="mancala.js"></script>
